{% from "platform/macros/theme.html.j2" import badge %}
{% from "platform/macros/profile.html.j2" import profile_picture %}
{% if request.args.pay_success %}<p role="status">Payment successful! Thank you :)</p>{% endif %}
{% if request.args.pay_cancel %}<p role="alert">Payment was cancelled!</p>{% endif %}
{% if is_dialog %}<a href="{{ url_for('.events', _anchor=event.slug) }}">< Return to Events</a>{% endif %}
<article id="{{ event.slug }}"
         hx-target="this"
         hx-swap="outerHTML"
         class="event card{{ ' event-past' if not event.is_upcoming() }}">
  <header class="flex">
    <div class="event-date">
      <span>{{ event.event_dt.strftime("%A") }}</span>
      <span>{{ event.event_dt.strftime("%-d") }}</span>
      <span>{{ event.event_dt.strftime("%b %Y") }}</span>
    </div>
    <div>
      <span class="flex">
        <h1>
          <a hx-target="#selectedEvent"
             hx-swap="innerHTML"
             hx-boost="true"
             href="{{ url_for('.event', id=event.id) }}">{{ event.title }}</a>
        </h1>
      </span>
      {{ badge(event.event_type.name) }}
      {% if event.is_members_only %}{{ badge("Members Only") }}{% endif %}
      {% if event.event_end_dt %}
        <p>
          {{ event.event_dt.strftime("%A, %b %d, %Y, %H:%M") }} ðŸ¡ª {{ event.event_end_dt.strftime("%A, %b %d, %Y, %H:%M") }}
        </p>
      {% else %}
        <p>&nbsp;{{ event.event_dt.strftime("%A, %b %d, %Y, %H:%M") }}</p>
      {% endif %}
    </div>
    {% if g.current_user.is_site_admin %}
      <details class="admin">
        <summary>Admin</summary>
        <article class="admin-panel">
          <a class="button" href="{{ url_for('.edit_event', id=event.id) }}">Edit event</a>
          <a class="button"
             href="{{ url_for('.edit_event', copy_from=event.id) }}">Copy event</a>
          <form method="post" action="{{ url_for('.event', id=event.id) }}">
            <input type="hidden" name="method" value="DELETE" />
            <input type="submit" value="Delete event" />
          </form>
        </article>
      </details>
    {% endif %}
  </header>
  {# Tiny bit of javascript to handle expansion of the description #}
  <section class="event-description"
           data-expanded="false"
           onclick="this.dataset.expanded = (this.dataset.expanded === 'false' ? 'true' : 'false') ">
    {{ event.description | markdown | safe }}
  </section>
  <section>
    {% set all_evt_attendees = attendees[event.id] | sort(attribute='joined_at_utc') %}
    {% set evt_attendees = all_evt_attendees | selectattr('is_waiting_list', 'equalto', False) | list %}
    {% set wait_attendees = all_evt_attendees | selectattr('is_waiting_list', 'equalto', True) | list %}
    {% set total_att = evt_attendees | length %}
    {% set total_wait = wait_attendees | length %}
    {% with attendees = evt_attendees, user_map=members, event=event, is_waiting_list=False %}
      {% include "events/_attendees.html.j2" %}
    {% endwith %}
    {% if total_wait > 0 %}
      {% with attendees = wait_attendees, user_map=members, event=event, is_waiting_list=True %}
        {% include "events/_attendees.html.j2" %}
      {% endwith %}
    {% endif %}
    {% set current_attendee = all_evt_attendees | selectattr('user_id', 'equalto', g.current_user.id) | first %}
    {% if event.is_upcoming() %}
      {% if current_attendee %}
        <form method="post"
              hx-post="{{ url_for('.attendee', event_id=event.id, user_id=g.current_user.id) }}"
              action="{{ url_for('.attendee', event_id=event.id, user_id=g.current_user.id) }}">
          <input type="hidden" name="method" value="DELETE" />
          {% if not current_attendee.is_waiting_list %}
            <input type="submit" class="btn-cancel" value="Leave" />
            {% if event.price_id %}
              {% if not current_attendee.is_trip_paid %}
                <a href="{{ url_for('.pay_event', user_id=current_attendee.user_id, event_id=current_attendee.event_id) }}"
                   class="button">Pay Now</a>
              {% else %}
                <button disabled>You've paid!</button>
              {% endif %}
            {% endif %}
          {% else %}
            <input type="submit" class="btn-cancel" value="Leave Waiting List" />
          {% endif %}
        </form>
      {% else %}
        <form method="post"
              hx-post="{{ url_for('.attend_event', event_id=event.id) }}"
              action="{{ url_for('.attend_event', event_id=event.id) }}">
          <input type="hidden" name="method" value="POST" />
          {% if total_wait > 0 or (total_att > 0 and event.max_attendees and total_att >= event.max_attendees) %}
            <input type="submit" value="Join Waiting List" />
          {% else %}
            {% if event.is_open() %}
              <input type="submit" value="Attend" />
            {% else %}
              {% set open_str = event.signup_open_dt.strftime('%b %-d, %Y %H:%M') %}
              <input type="button" disabled value="Signup opens at {{ open_str }}" />
            {% endif %}
          </form>
        {% endif %}
      {% endif %}
    {% endif %}
    {% if event.price_id and current_attendee and not current_attendee.is_waiting_list %}{% endif %}
  </section>
</article>
